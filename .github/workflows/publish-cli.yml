name: Vespa CLI - Build and Publish

on:
  push:
    tags:
      - v*
  pull_request:
    branches:
      - master
    paths:
      - .github/workflows/publish-cli.yml
      - client/go/**
  workflow_dispatch:
    inputs:
      version:
        description: 'The version to build and publish, it MUST be a tag in this repository without the "v" prefix.'
        required: true
        type: string

defaults:
  run:
    # Specify to ensure "pipefail and errexit" are set.
    # Ref: https://docs.github.com/en/actions/writing-workflows/workflow-syntax-for-github-actions#defaultsrunshell
    shell: bash

jobs:
  prepare:
    runs-on: ubuntu-latest

    outputs:
      build-version: ${{ steps.meta.outputs.version }}

    steps:
      - name: Define Build Version
        id: meta
        run: |
          if [[ "${{ github.event_name }}" == "push" && "${{ startswith(github.ref, 'refs/tags/v') }}" == "true" ]]; then
            # Remove the "v" prefix from the tag.
            BUILD_VERSION="${GITHUB_REF_NAME#*v}"
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            BUILD_VERSION="${{ github.event.inputs.version }}"
          else
            BUILD_VERSION="0.0.0-dev_${{ github.run_number }}"
          fi

          echo "version=${BUILD_VERSION}" >> $GITHUB_OUTPUT

  build-test:
    runs-on: ubuntu-latest

    needs:
      - prepare

    defaults:
      run:
        # This workflow only interacts with the client/go directory, so we can set the working directory here.
        working-directory: client/go

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5

      - name: build
        env:
          VERSION: ${{ needs.prepare.outputs.build-version }}
        run: |
          make clean dist

      - name: test
        run: |
          make test

      - uses: actions/upload-artifact@v4
        with:
          name: vespa-cli
          path: client/go/dist
          retention-days: 1

  publish:
    runs-on: macos-latest

    # Publish the CLI when a tag is pushed or a workflow is triggered manually.
    if: contains(fromJSON('["push", "workflow_dispatch"]'), github.event_name)
    needs:
      - prepare
      - build-test

    permissions:
      contents: write

    defaults:
      run:
        # This workflow only interacts with the client/go directory, so we can set the working directory here.
        working-directory: client/go

    env:
      VERSION: ${{ needs.prepare.outputs.build-version }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/download-artifact@v4
        with:
          name: vespa-cli
          path: client/go/dist

      - name: install-dependencies
        env:
          HOMEBREW_NO_ANALYTICS: 1
          HOMEBREW_NO_AUTO_UPDATE: 1
          HOMEBREW_NO_INSTALL_CLEANUP: 1
        run: |
          brew install --quiet coreutils gh zip go

      - name: Publish to GitHub Releases
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          make clean dist-github

      - name: Publish to Homebrew
        env:
          HOMEBREW_GITHUB_API_TOKEN: ${{ secrets.HOMEBREW_GITHUB_API_TOKEN }}
        run: |
          make clean dist-homebrew

      - name: Install via Homebrew
        run: |
          make install-brew
